<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EnergyChain â€“ Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/ethers@6.13.1/dist/ethers.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.3/chart.umd.min.js"></script>
  <style>
    .energy-gradient { background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%); }
    .solar-gradient { background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%); }
    .gradient-text { 
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
      background-clip: text; 
    }
    .solar-text { 
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
      background-clip: text; 
    }
    .btn-g { transition: all .3s; position: relative; overflow: hidden; }
    .btn-glow::before { 
      content: ''; 
      position: absolute; 
      top: 0; 
      left: -100%; 
      width: 100%; 
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.3), transparent); 
      transition: left .5s; 
    }
    .btn-glow:hover::before { left: 100%; }
    .btn-glow:hover { box-shadow: 0 0 30px rgba(16,185,129,.6); transform: translateY(-2px); }
    .btn-solar-glow:hover { box-shadow: 0 0 30px rgba(245,158,11,.6); }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      pointer-events: none !important;
    }
    button:disabled::before, button:disabled:hover::before { display: none !important; }
    button:disabled:hover { box-shadow: none !important; transform: none !important; }
    .toast { 
      position: fixed; 
      bottom: 20px; 
      right: 20px; 
      padding: 12px 24px; 
      border-radius: 8px; 
      color: white; 
      z-index: 1000; 
      opacity: 0; 
      transition: opacity 0.3s; 
    }
    .toast.show { opacity: 1; }
    .toast-success { background: #10b981; }
    .toast-error { background: #ef4444; }
    .toast-warning { background: #f59e0b; }
    .invalid { border-color: #ef4444 !important; }
    .prediction-card {
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      border: 2px solid #f59e0b;
    }
    @media (max-width: 640px) {
      .table-container { overflow-x: auto; }
      canvas { max-width: 100%; }
    }
  </style>
</head>
<body class="font-sans antialiased bg-gray-50">
  <!-- Navbar -->
  <nav class="fixed w-full top-0 z-50 bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
      <div class="flex items-center space-x-3">
        <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"/>
        </svg>
        <div class="text-2xl font-bold gradient-text">EnergyChain</div>
      </div>
      <div class="flex items-center space-x-4">
        <button id="logoutBtn" class="energy-gradient text-white px-6 py-2 rounded-lg font-semibold btn-glow">Log Out</button>
      </div>
    </div>
  </nav>

  <!-- Main Dashboard -->
  <section class="pt-24 pb-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
      <h1 class="text-4xl font-bold gradient-text mb-8 text-center">Energy Marketplace Dashboard</h1>

      <!-- Connect Wallet -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-8 text-center">
        <button id="connectBtn" class="energy-gradient text-white px-8 py-3 rounded-lg font-semibold btn-glow">
          Connect MetaMask / Wallet
        </button>
        <p id="accountDisplay" class="mt-4 text-gray-600"></p>
      </div>

      <!-- Profile Card -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-semibold mb-4">Your Profile</h2>
        <div class="grid md:grid-cols-3 gap-4 text-gray-700">
          <div><strong>Name:</strong> <span id="profileName">-</span></div>
          <div><strong>Email:</strong> <span id="profileEmail">-</span></div>
          <div><strong>Wallet:</strong> <code id="profileWallet">-</code></div>
        </div>
      </div>

      <!-- Solar Power Prediction Section -->
      <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl shadow-lg p-6 mb-8 border-2 border-amber-200">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center space-x-3">
            <svg class="w-8 h-8 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"/>
            </svg>
            <h2 class="text-2xl font-bold solar-text">Solar Power Prediction</h2>
          </div>
          <span class="bg-amber-600 text-white px-3 py-1 rounded-full text-sm font-semibold">AI-Powered</span>
        </div>

        <p class="text-gray-700 mb-6">Predict AC power output from your solar panels using our machine learning model. Enter real-time sensor data below.</p>

        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
          <div>
            <label class="block text-gray-700 font-medium mb-2">
              <span class="flex items-center">
                <svg class="w-4 h-4 mr-2 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"/>
                </svg>
                Date & Time
              </span>
            </label>
            <input id="solarDateTime" type="datetime-local" 
                   class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-amber-500">
          </div>

          <div>
            <label class="block text-gray-700 font-medium mb-2">
              <span class="flex items-center">
                <svg class="w-4 h-4 mr-2 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>
                Irradiation (W/mÂ²)
              </span>
            </label>
            <input id="solarIrradiation" type="number" step="0.01" placeholder="800.5"
                   class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-amber-500">
            <p class="text-xs text-gray-500 mt-1">Typical range: 0-1200 W/mÂ²</p>
          </div>

          <div>
            <label class="block text-gray-700 font-medium mb-2">
              <span class="flex items-center">
                <svg class="w-4 h-4 mr-2 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"/>
                </svg>
                Ambient Temperature (Â°C)
              </span>
            </label>
            <input id="solarAmbient" type="number" step="0.1" placeholder="25.5"
                   class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-amber-500">
            <p class="text-xs text-gray-500 mt-1">Typical range: -10 to 50Â°C</p>
          </div>

          <div>
            <label class="block text-gray-700 font-medium mb-2">
              <span class="flex items-center">
                <svg class="w-4 h-4 mr-2 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z"/>
                </svg>
                Module Temperature (Â°C)
              </span>
            </label>
            <input id="solarModule" type="number" step="0.1" placeholder="45.2"
                   class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-amber-500">
            <p class="text-xs text-gray-500 mt-1">Typical range: 0 to 85Â°C</p>
          </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 mb-6">
          <button id="predictBtn" 
                  class="solar-gradient text-white px-8 py-3 rounded-lg font-semibold btn-glow btn-solar-glow flex items-center justify-center">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"/>
            </svg>
            <span id="predictText">Predict AC Power</span>
            <span id="predictSpinner" class="hidden ml-2">
              <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </span>
          </button>

          <button id="fillSampleBtn" 
                  class="bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold btn-glow flex items-center justify-center">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
              <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm9.707 5.707a1 1 0 00-1.414-1.414L9 12.586l-1.293-1.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
            </svg>
            Fill Sample Data
          </button>
        </div>

        <!-- Prediction Result -->
        <div id="predictionResult" class="hidden prediction-card rounded-lg p-6 animate-fade-in">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-amber-900">Prediction Result</h3>
            <svg class="w-6 h-6 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
            </svg>
          </div>
          
          <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg p-4 shadow-sm">
              <p class="text-sm text-gray-600 mb-2">Predicted AC Power Output</p>
              <p class="text-4xl font-bold text-amber-600"><span id="predictedPower">0.00</span> <span class="text-2xl">kW</span></p>
            </div>
            
            <div class="bg-white rounded-lg p-4 shadow-sm">
              <p class="text-sm text-gray-600 mb-2">Input Parameters</p>
              <div class="text-sm space-y-1">
                <p><strong>Irradiation:</strong> <span id="resultIrradiation">-</span> W/mÂ²</p>
                <p><strong>Ambient Temp:</strong> <span id="resultAmbient">-</span> Â°C</p>
                <p><strong>Module Temp:</strong> <span id="resultModule">-</span> Â°C</p>
                <p><strong>Time:</strong> <span id="resultTime">-</span></p>
              </div>
            </div>
          </div>

          <div class="mt-4 p-4 bg-amber-100 rounded-lg border border-amber-300">
            <p class="text-sm text-amber-900">
              <strong>ðŸ’¡ Tip:</strong> Use this prediction to optimize your energy offers on the marketplace!
            </p>
          </div>
        </div>
      </div>

      <!-- Create Offer -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-semibold mb-4">Create Energy Offer</h2>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-gray-700 font-medium mb-2">Your Name (public)</label>
            <input id="userName" type="text" placeholder="John Doe"
                   class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-green-500">
            <p id="userNameError" class="text-sm text-red-600 hidden">Name is required</p>
          </div>
          <div>
            <label class="block text-gray-700 font-medium mb-2">Price (ETH) â‰¥ 0.01</label>
            <input id="priceEth" type="number" step="0.001" min="0.01" placeholder="0.05"
                   class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-green-500">
            <p id="priceEthError" class="text-sm text-red-600 hidden">Price must be â‰¥ 0.01 ETH</p>
          </div>
        </div>
        <button id="createOfferBtn" disabled
                class="mt-4 energy-gradient text-white w-full py-3 rounded-lg font-semibold btn-glow flex items-center justify-center">
          <span id="createText">Create Offer</span>
          <span id="createSpinner" class="hidden ml-2">
            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </span>
        </button>
        <p class="mt-2 text-sm text-gray-600">Minimum price: <strong>0.01 ETH</strong></p>
      </div>

      <!-- Filters and Toggle -->
      <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
        <div class="flex items-center space-x-4">
          <label class="flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="showAllToggle" class="rounded" checked>
            <span class="text-sm text-gray-600">Show all marketplace offers</span>
          </label>
        </div>
        <div class="flex items-center space-x-2">
          <label class="text-sm text-gray-600">Sort by:</label>
          <select id="sortOffers" class="border rounded px-2 py-1">
            <option value="id">Offer ID</option>
            <option value="priceAsc">Price (Low to High)</option>
            <option value="priceDesc">Price (High to Low)</option>
            <option value="dateDesc">Date (Newest)</option>
          </select>
        </div>
      </div>

      <!-- Offers Table -->
      <div class="bg-white rounded-xl shadow-lg p-6 table-container">
        <h2 class="text-2xl font-semibold mb-4">Active Offers</h2>
        <div id="offersContainer" class="space-y-3">
          <p class="text-gray-500 text-center">Loading offers from blockchainâ€¦</p>
        </div>
      </div>

      <!-- Accepted Offers History -->
      <div class="bg-white rounded-xl shadow-lg p-6 mt-8 table-container">
        <h2 class="text-2xl font-semibold mb-4">Accepted Offers (History)</h2>
        <div id="acceptedContainer" class="space-y-3">
          <p class="text-gray-500 text-center">No accepted offers yet.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- ==================== SCRIPT ==================== -->
  <script>
    // -------------------------------------------------
    // GLOBAL STATE
    // -------------------------------------------------
    let hasRequested = false;
    let hasConnected = false;
    let provider, signer, contract, userAddress, userHash;
    let acceptedOffers = JSON.parse(localStorage.getItem("acceptedOffers")) || [];
    let priceChart, acceptedChart;
    let pollInterval;

    // -------------------------------------------------
    // NETWORK CONFIG
    // -------------------------------------------------
    const CONFIG = {
      networks: {
        11155111: { name: "Sepolia Testnet", rpc: "https://eth-sepolia.g.alchemy.com/v2/demo" },
        "0xaa36a7": { name: "Sepolia Testnet", rpc: "https://eth-sepolia.g.alchemy.com/v2/demo" }
      }
    };

    // -------------------------------------------------
    // SOLAR PREDICTION FUNCTIONS
    // -------------------------------------------------
    function calculateTimeFeatures(dateTime) {
      const hour = dateTime.getHours();
      const minute = dateTime.getMinutes();
      
      return {
        hour_sin: Math.sin(2 * Math.PI * hour / 24),
        hour_cos: Math.cos(2 * Math.PI * hour / 24),
        minute_sin: Math.sin(2 * Math.PI * minute / 60),
        minute_cos: Math.cos(2 * Math.PI * minute / 60)
      };
    }

    async function predictSolarPower() {
      const dateTimeInput = document.getElementById("solarDateTime").value;
      const irradiation = parseFloat(document.getElementById("solarIrradiation").value);
      const ambientTemp = parseFloat(document.getElementById("solarAmbient").value);
      const moduleTemp = parseFloat(document.getElementById("solarModule").value);

      // Validation
      if (!dateTimeInput || isNaN(irradiation) || isNaN(ambientTemp) || isNaN(moduleTemp)) {
        showToast("Please fill in all solar prediction fields", "error");
        return;
      }

      if (irradiation < 0 || irradiation > 1500) {
        showToast("Irradiation should be between 0-1500 W/mÂ²", "warning");
      }

      const btn = document.getElementById("predictBtn");
      const txt = document.getElementById("predictText");
      const spin = document.getElementById("predictSpinner");
      txt.textContent = "Predicting...";
      spin.classList.remove("hidden");
      btn.disabled = true;

      try {
        const dateTime = new Date(dateTimeInput);
        const timeFeatures = calculateTimeFeatures(dateTime);

        // Simulate ML model prediction (replace with actual API call)
        const features = {
          IRRADIATION: irradiation,
          AMBIENT_TEMPERATURE: ambientTemp,
          MODULE_TEMPERATURE: moduleTemp,
          hour_sin: timeFeatures.hour_sin,
          hour_cos: timeFeatures.hour_cos,
          minute_sin: timeFeatures.minute_sin,
          minute_cos: timeFeatures.minute_cos
        };

        // Simple heuristic model (replace with actual ML model call)
        // This is a placeholder - you'll need to implement actual API call to your ML model
        let predictedPower = (irradiation / 1000) * 5 * 
                            (1 - (moduleTemp - 25) * 0.004) * 
                            (1 + (ambientTemp - 25) * 0.002);
        
        // Add time-based variation
        const hourEffect = (timeFeatures.hour_cos + 1) / 2;
        predictedPower *= hourEffect;
        
        predictedPower = Math.max(0, predictedPower).toFixed(2);

        // Display results
        document.getElementById("predictedPower").textContent = predictedPower;
        document.getElementById("resultIrradiation").textContent = irradiation.toFixed(2);
        document.getElementById("resultAmbient").textContent = ambientTemp.toFixed(1);
        document.getElementById("resultModule").textContent = moduleTemp.toFixed(1);
        document.getElementById("resultTime").textContent = dateTime.toLocaleString();
        document.getElementById("predictionResult").classList.remove("hidden");

        showToast("Solar power prediction completed successfully!", "success");
      } catch (e) {
        console.error("Prediction error:", e);
        showToast("Prediction failed. Please check your inputs.", "error");
      } finally {
        txt.textContent = "Predict AC Power";
        spin.classList.add("hidden");
        btn.disabled = false;
      }
    }

    function fillSampleData() {
      const now = new Date();
      const dateTimeString = now.toISOString().slice(0, 16);
      
      document.getElementById("solarDateTime").value = dateTimeString;
      document.getElementById("solarIrradiation").value = "850.5";
      document.getElementById("solarAmbient").value = "28.5";
      document.getElementById("solarModule").value = "45.2";
      
      showToast("Sample data filled. Click 'Predict AC Power' to see results.", "success");
    }

    // Event listeners for solar prediction
    document.getElementById("predictBtn").addEventListener("click", predictSolarPower);
    document.getElementById("fillSampleBtn").addEventListener("click", fillSampleData);

    // -------------------------------------------------
    // LOAD CONTRACT ADDRESS
    // -------------------------------------------------
    async function loadConfig() {
      let chainId;
      try {
        chainId = await window.ethereum.request({ method: 'eth_chainId' });
      } catch (e) {
        showToast("MetaMask not detected", "error");
        return false;
      }

      const chainIdDec = parseInt(chainId, 16);
      const network = CONFIG.networks[chainIdDec] || CONFIG.networks[chainId];
      if (!network) {
        showToast(`Please switch to Sepolia Testnet! Current: ${chainId}`, "error");
        return false;
      }

      let config;
      try {
        config = await fetch('/config/contract_address.json').then(r => r.json());
      } catch (e) {
        showToast('contract_address.json not found', "error");
        return false;
      }

      const CONTRACT_ADDRESS = config[chainIdDec] || config[chainId];
      if (!CONTRACT_ADDRESS) {
        showToast(`No contract on ${network.name}`, "error");
        return false;
      }

      console.log(`Connected to ${network.name}: ${CONTRACT_ADDRESS}`);
      return { CONTRACT_ADDRESS, network };
    }

    // -------------------------------------------------
    // UTILITY FUNCTIONS
    // -------------------------------------------------
    function hashUsername(name) {
      return ethers.keccak256(ethers.toUtf8Bytes(String(name).trim().toLowerCase()));
    }

    function escapeHtml(s) {
      if (s === undefined || s === null) return "";
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function showToast(message, type = "success") {
      const toast = document.getElementById("toast");
      toast.innerHTML = message;
      toast.className = `toast toast-${type} show`;
      setTimeout(() => {
        toast.className = `toast toast-${type}`;
      }, 3000);
    }

    function validateForm() {
      const name = document.getElementById("userName").value.trim();
      const price = parseFloat(document.getElementById("priceEth").value);
      const nameError = document.getElementById("userNameError");
      const priceError = document.getElementById("priceEthError");
      let valid = true;

      if (!nameError || !priceError) {
        console.error("Form elements not found");
        return false;
      }

      if (!name) {
        nameError.classList.remove("hidden");
        document.getElementById("userName").classList.add("invalid");
        valid = false;
      } else {
        nameError.classList.add("hidden");
        document.getElementById("userName").classList.remove("invalid");
      }

      if (!price || price < 0.01) {
        priceError.classList.remove("hidden");
        document.getElementById("priceEth").classList.add("invalid");
        valid = false;
      } else {
        priceError.classList.add("hidden");
        document.getElementById("priceEth").classList.remove("invalid");
      }

      document.getElementById("createOfferBtn").disabled = !valid || !hasConnected;
      return valid;
    }

    // -------------------------------------------------
    // LOGIN CHECK
    // -------------------------------------------------
    document.addEventListener("DOMContentLoaded", async () => {
      const isLoggedIn = sessionStorage.getItem("isLoggedIn") === "true";
      const userName = sessionStorage.getItem("userName");
      const userEmail = sessionStorage.getItem("userEmail");

      if (!isLoggedIn || !userName || !userEmail) {
        showToast("Please log in.", "error");
        window.location.href = "login.html";
        return;
      }

      document.getElementById("profileName").textContent = userName;
      document.getElementById("profileEmail").textContent = userEmail;
      document.getElementById("userName").value = userName;
      userHash = hashUsername(userName);

      // Set current date/time for solar prediction
      const now = new Date();
      document.getElementById("solarDateTime").value = now.toISOString().slice(0, 16);

      if (typeof Chart !== "undefined") {
        initializeCharts();
        updateAcceptedList();
      } else {
        showToast("Failed to load Chart.js. Visualizations disabled.", "error");
        updateAcceptedList();
      }
    });

    // -------------------------------------------------
    // CONNECT WALLET
    // -------------------------------------------------
    async function connectWallet() {
      if (hasRequested || hasConnected) return;

      hasRequested = true;
      const btn = document.getElementById("connectBtn");
      btn.textContent = "Connecting...";
      btn.disabled = true;

      try {
        if (!window.ethereum) throw new Error("Install MetaMask!");

        const config = await loadConfig();
        if (!config) throw new Error("Network error");

        provider = new ethers.BrowserProvider(window.ethereum);
        const accounts = await provider.send("eth_requestAccounts", []);
        if (!accounts.length) throw new Error("No account");

        signer = await provider.getSigner();
        userAddress = await signer.getAddress();
        contract = new ethers.Contract(config.CONTRACT_ADDRESS, CONTRACT_ABI, signer);

        const shortAddr = `${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;
        document.getElementById("accountDisplay").textContent = `Connected: ${shortAddr}`;
        document.getElementById("profileWallet").textContent = shortAddr;

        btn.innerHTML = `
          <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
          </svg>
          Connected
        `;
        btn.classList.remove("btn-glow");
        document.getElementById("createOfferBtn").disabled = !validateForm();
        hasConnected = true;

        await loadOffers();
        listenForAccepts();
        listenForCreates();
        startPolling();
      } catch (e) {
        console.error(e);
        if (e.code === -32002) {
          showToast("MetaMask is busy. Check popup, refresh, and click Connect ONCE.", "error");
        } else {
          showToast(e.message || "Connection failed", "error");
        }
        btn.textContent = "Try Again";
        btn.disabled = false;
        hasRequested = false;
      }
    }

    document.getElementById("connectBtn").addEventListener("click", connectWallet);

    window.addEventListener("load", () => {
      if (window.ethereum?.selectedAddress && !hasConnected && !hasRequested) {
        setTimeout(connectWallet, 800);
      }
    });

    window.ethereum?.on("accountsChanged", () => {
      hasConnected = false;
      hasRequested = false;
      clearInterval(pollInterval);
      connectWallet();
    });

    window.ethereum?.on("chainChanged", () => {
      clearInterval(pollInterval);
      window.location.reload();
    });

    // -------------------------------------------------
    // CREATE OFFER
    // -------------------------------------------------
    document.getElementById("createOfferBtn").addEventListener("click", async () => {
      if (!validateForm()) return;

      const name = document.getElementById("userName").value.trim();
      const priceEth = document.getElementById("priceEth").value;
      const priceWei = ethers.parseEther(String(priceEth));
      const userHashLocal = hashUsername(name);

      const btn = document.getElementById("createOfferBtn");
      const txt = document.getElementById("createText");
      const spin = document.getElementById("createSpinner");
      txt.textContent = "Sendingâ€¦";
      spin.classList.remove("hidden");
      btn.disabled = true;

      try {
        const tx = await contract.createOffer(userHashLocal, priceWei);
        await tx.wait();
        showToast(`Offer created! Tx: <a href="https://sepolia.etherscan.io/tx/${tx.hash}" target="_blank" class="underline">View</a>`, "success");
        document.getElementById("priceEth").value = "";
        await loadOffers();
      } catch (e) {
        console.error("createOffer failed", e);
        showToast(e.reason || e.message || "Transaction failed", "error");
      } finally {
        txt.textContent = "Create Offer";
        spin.classList.add("hidden");
        btn.disabled = !validateForm();
      }
    });

    document.getElementById("userName").addEventListener("input", validateForm);
    document.getElementById("priceEth").addEventListener("input", validateForm);

    // -------------------------------------------------
    // LOAD OFFERS
    // -------------------------------------------------
    async function loadOffers() {
      const container = document.getElementById("offersContainer");
      container.innerHTML = "<p class='text-gray-500 text-center'>Loadingâ€¦</p>";

      if (!contract) {
        container.innerHTML = "<p class='text-gray-500 text-center'>Connect wallet.</p>";
        return;
      }

      try {
        const showAll = document.getElementById("showAllToggle").checked;
        const sortBy = document.getElementById("sortOffers").value;
        let offerIds = [];

        if (showAll) {
          const countBN = await contract.getOfferCount();
          const count = Number(countBN);
          offerIds = Array.from({ length: count }, (_, i) => i);
        } else {
          offerIds = await contract.getActiveUserOfferIds(userHash);
        }

        const offers = [];
        for (let i of offerIds) {
          const offerRaw = await contract.getOffer(i);
          const uHash = offerRaw[0];
          const priceWei = offerRaw[1];
          const ts = offerRaw[2];
          const active = offerRaw[3];

          if (!active) continue;

          offers.push({
            id: i,
            userHash: uHash,
            priceEth: parseFloat(ethers.formatEther(priceWei)),
            timestamp: Number(ts) * 1000,
            date: new Date(Number(ts) * 1000).toLocaleString()
          });
        }

        offers.sort((a, b) => {
          if (sortBy === "priceAsc") return a.priceEth - b.priceEth;
          if (sortBy === "priceDesc") return b.priceEth - a.priceEth;
          if (sortBy === "dateDesc") return b.timestamp - a.timestamp;
          return a.id - b.id;
        });

        const fragment = document.createDocumentFragment();
        let foundAny = false;

        for (const offer of offers) {
          foundAny = true;
          const isMine = offer.userHash === userHash;
          const displayName = isMine ? sessionStorage.getItem("userName") : (String(offer.userHash).slice(0, 10) + "...");

          const card = document.createElement("div");
          card.className = "flex justify-between items-center p-4 border rounded-lg";

          const left = document.createElement("div");
          left.innerHTML = `
            <p class="font-medium">Offer #${offer.id}</p>
            <p class="text-sm text-gray-600">${escapeHtml(displayName)}</p>
            <p class="text-sm text-gray-600">Price: <strong>${escapeHtml(offer.priceEth)} ETH</strong></p>
            <p class="text-xs text-gray-500">${escapeHtml(offer.date)}</p>
          `;

          const right = document.createElement("div");
          const btn = document.createElement("button");
          btn.className = `text-white px-4 py-1 rounded btn-glow text-sm flex items-center`;
          btn.dataset.id = String(offer.id);

          if (isMine) {
            btn.className += " bg-red-600";
            btn.textContent = "Cancel";
            btn.addEventListener("click", async (ev) => {
              const id = Number(ev.currentTarget.dataset.id);
              if (!confirm(`Cancel offer #${id}?`)) return;
              try {
                const tx = await contract.cancelOffer(id);
                await tx.wait();
                showToast(`Offer cancelled! Tx: <a href="https://sepolia.etherscan.io/tx/${tx.hash}" target="_blank" class="underline">View</a>`, "success");
                await loadOffers();
              } catch (err) {
                console.error("cancelOffer failed", err);
                showToast(err.reason || err.message || "Cancel failed", "error");
              }
            });
          } else {
            btn.className += " bg-green-600";
            btn.innerHTML = `
              <span>Accept</span>
              <span class="hidden ml-2">
                <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </span>
            `;
            btn.dataset.price = offer.priceEth;
            btn.dataset.sellerhash = offer.userHash;
            btn.addEventListener("click", async (ev) => {
              const id = Number(ev.currentTarget.dataset.id);
              const priceStr = ev.currentTarget.dataset.price;
              const sellerHash = ev.currentTarget.dataset.sellerhash;
              const sellerName = getNameFromHash(sellerHash);

              if (!confirm(`Accept from ${sellerName} for ${priceStr} ETH?`)) return;

              const txt = ev.currentTarget.querySelector("span:first-child");
              const spin = ev.currentTarget.querySelector("span:last-child");
              txt.textContent = "Acceptingâ€¦";
              spin.classList.remove("hidden");
              ev.currentTarget.disabled = true;

              try {
                const value = ethers.parseEther(String(priceStr));
                const tx = await contract.acceptOffer(id, { value });
                await tx.wait();
                showToast(`Offer accepted! Tx: <a href="https://sepolia.etherscan.io/tx/${tx.hash}" target="_blank" class="underline">View</a>`, "success");
                await loadOffers();
              } catch (err) {
                console.error("acceptOffer failed", err);
                showToast(err.reason || err.message || "Accept failed", "error");
              } finally {
                txt.textContent = "Accept";
                spin.classList.add("hidden");
                ev.currentTarget.disabled = false;
              }
            });
          }

          right.appendChild(btn);
          card.appendChild(left);
          card.appendChild(right);
          fragment.appendChild(card);
        }

        if (!foundAny) {
          container.innerHTML = "<p class='text-center text-gray-500'>No offers.</p>";
        } else {
          container.innerHTML = "";
          container.appendChild(fragment);
        }

        if (priceChart) {
          updatePriceChart(offers);
        }
      } catch (e) {
        console.error("loadOffers failed", e);
        container.innerHTML = "<p class='text-red-600'>Load failed.</p>";
      }
    }

    // -------------------------------------------------
    // CHART INITIALIZATION
    // -------------------------------------------------
    function initializeCharts() {
      console.log("Initializing charts with Chart.js");
      priceChart = new Chart(document.getElementById("priceChart"), {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Offer Prices (ETH)',
            data: [],
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.2)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Price (ETH)' }
            },
            x: {
              title: { display: true, text: 'Offer ID' }
            }
          }
        }
      });

      acceptedChart = new Chart(document.getElementById("acceptedChart"), {
        type: 'pie',
        data: {
          labels: [],
          datasets: [{
            data: [],
            backgroundColor: ['#10b981', '#059669', '#047857', '#34d399', '#6ee7b7']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'Accepted Offers by Seller' }
          }
        }
      });
    }

    function updatePriceChart(offers) {
      if (!priceChart) return;
      const labels = offers.map(o => `Offer #${o.id}`);
      const data = offers.map(o => o.priceEth);
      priceChart.data.labels = labels;
      priceChart.data.datasets[0].data = data;
      priceChart.update();
    }

    function updateAcceptedChart() {
      if (!acceptedChart) return;
      const sellerCounts = {};
      acceptedOffers.forEach(offer => {
        sellerCounts[offer.seller] = (sellerCounts[offer.seller] || 0) + 1;
      });

      const labels = Object.keys(sellerCounts);
      const data = Object.values(sellerCounts);

      acceptedChart.data.labels = labels.length ? labels : ['No Data'];
      acceptedChart.data.datasets[0].data = data.length ? data : [1];
      acceptedChart.update();
    }

    // -------------------------------------------------
    // LISTEN FOR OFFER ACCEPTED EVENT
    // -------------------------------------------------
    async function listenForAccepts() {
      if (!contract) return;

      try { contract.off("OfferAccepted"); } catch(e) {}

      contract.on("OfferAccepted", (offerId, buyer, sellerHash, price, timestamp, event) => {
        try {
          const priceEth = ethers.formatEther(price);
          const date = new Date(Number(timestamp) * 1000).toLocaleString();
          const sellerName = getNameFromHash(sellerHash);

          acceptedOffers.push({
            id: offerId.toString(),
            buyer: buyer.slice(0, 6) + "..." + buyer.slice(-4),
            seller: sellerName,
            price: priceEth,
            date: date
          });

          localStorage.setItem("acceptedOffers", JSON.stringify(acceptedOffers));
          updateAcceptedList();
          if (acceptedChart) updateAcceptedChart();
          loadOffers();
        } catch (err) {
          console.error("Error in OfferAccepted handler", err);
        }
      });

      try {
        const filter = contract.filters.OfferAccepted();
        const events = await contract.queryFilter(filter, -1000, "latest");
        for (const e of events) {
          const { offerId, buyer, sellerHash, price, timestamp } = e.args;
          const priceEth = ethers.formatEther(price);
          const date = new Date(Number(timestamp) * 1000).toLocaleString();
          const sellerName = getNameFromHash(sellerHash);

          if (!acceptedOffers.some(o => o.id === offerId.toString())) {
            acceptedOffers.push({
              id: offerId.toString(),
              buyer: buyer.slice(0, 6) + "..." + buyer.slice(-4),
              seller: sellerName,
              price: priceEth,
              date: date
            });
          }
        }
        localStorage.setItem("acceptedOffers", JSON.stringify(acceptedOffers));
        updateAcceptedList();
        if (acceptedChart) updateAcceptedChart();
      } catch (e) {
        console.error("Failed to load past accepts", e);
      }
    }

    // -------------------------------------------------
    // LISTEN FOR OFFER CREATED EVENT
    // -------------------------------------------------
    async function listenForCreates() {
      if (!contract) return;

      try { contract.off("OfferCreated"); } catch(e) {}

      contract.on("OfferCreated", (offerId, userHash, price, timestamp, event) => {
        try {
          console.log(`New offer created: #${offerId}`);
          loadOffers();
        } catch (err) {
          console.error("Error in OfferCreated handler", err);
        }
      });
    }

    // -------------------------------------------------
    // POLL FOR OFFERS
    // -------------------------------------------------
    function startPolling() {
      clearInterval(pollInterval);
      pollInterval = setInterval(async () => {
        if (hasConnected && contract) {
          console.log("Polling for new offers...");
          await loadOffers();
        }
      }, 30000);
    }

    function getNameFromHash(hash) {
      const currentName = sessionStorage.getItem("userName");
      if (!hash) return "";
      try {
        if (hash === hashUsername(currentName)) return currentName;
      } catch (e) {}
      return String(hash).slice(0, 10) + "...";
    }

    function updateAcceptedList() {
      const container = document.getElementById("acceptedContainer");
      if (!acceptedOffers.length) {
        container.innerHTML = "<p class='text-gray-500 text-center'>No accepted offers yet.</p>";
        return;
      }

      const rows = acceptedOffers.map(offer => `
        <div class="flex justify-between items-center p-4 border rounded-lg bg-green-50">
          <div>
            <p class="font-medium">Offer #${escapeHtml(offer.id)} Accepted</p>
            <p class="text-sm text-gray-600">Buyer: <strong>${escapeHtml(offer.buyer)}</strong></p>
            <p class="text-sm text-gray-600">Seller: <strong>${escapeHtml(offer.seller)}</strong></p>
            <p class="text-sm text-gray-600">Price: <strong>${escapeHtml(offer.price)} ETH</strong></p>
            <p class="text-xs text-gray-500">${escapeHtml(offer.date)}</p>
          </div>
          <span class="text-green-600 font-semibold text-sm">Completed</span>
        </div>
      `);

      container.innerHTML = rows.join("");
    }

    // -------------------------------------------------
    // EVENT LISTENERS
    // -------------------------------------------------
    document.getElementById("showAllToggle").addEventListener("change", loadOffers);
    document.getElementById("sortOffers").addEventListener("change", loadOffers);

    // -------------------------------------------------
    // LOGOUT
    // -------------------------------------------------
    document.getElementById("logoutBtn").addEventListener("click", () => {
      clearInterval(pollInterval);
      sessionStorage.clear();
      window.location.href = "login.html";
    });

    // -------------------------------------------------
    // ABI
    // -------------------------------------------------
    const CONTRACT_ABI = [
      "function createOffer(bytes32 userHash, uint256 price)",
      "function getOfferCount() view returns (uint256)",
      "function getOffer(uint256 id) view returns (bytes32, uint256, uint256, bool)",
      "function cancelOffer(uint256 id)",
      "function acceptOffer(uint256 id) payable",
      "function getActiveUserOfferIds(bytes32 userHash) view returns (uint256[])",
      "event OfferCreated(uint256 indexed offerId, bytes32 indexed userHash, uint256 price, uint256 timestamp)",
      "event OfferAccepted(uint256 indexed offerId, address buyer, bytes32 sellerHash, uint256 price, uint256 timestamp)"
    ];
  </script>
</body>
</html>