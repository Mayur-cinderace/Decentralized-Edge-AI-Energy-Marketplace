<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EnergyChain – Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.ethers.io/lib/ethers-6.13.1.umd.min.js" type="text/javascript"></script>
  <style>
    .energy-gradient { background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%); }
    .gradient-text { background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .btn-g { transition: all .3s; position:relative; overflow:hidden; }
    .btn-glow::before { content:''; position:absolute; top:0; left:-100%; width:100%; height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent); transition:left .5s; }
    .btn-glow:hover::before { left:100%; }
    .btn-glow:hover { box-shadow:0 0 30px rgba(16,185,129,.6); transform:translateY(-2px); }
  </style>
</head>
<body class="font-sans antialiased bg-gray-50">

  <!-- Navbar -->
  <nav class="fixed w-full top-0 z-50 bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
      <div class="flex items-center space-x-3">
        <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"/>
        </svg>
        <div class="text-2xl font-bold gradient-text">EnergyChain</div>
      </div>
      <div class="flex items-center space-x-4">
        <button id="logoutBtn" class="energy-gradient text-white px-6 py-2 rounded-lg font-semibold btn-glow">Log Out</button>
      </div>
    </div>
  </nav>

  <!-- Main Dashboard -->
  <section class="pt-24 pb-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">

      <h1 class="text-4xl font-bold gradient-text mb-8 text-center">Energy Marketplace Dashboard</h1>

      <!-- Connect Wallet -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-8 text-center">
        <button id="connectBtn" class="energy-gradient text-white px-8 py-3 rounded-lg font-semibold btn-glow">
          Connect MetaMask / Wallet
        </button>
        <p id="accountDisplay" class="mt-4 text-gray-600"></p>
      </div>

      <!-- Create Offer -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-semibold mb-4">Create Energy Offer</h2>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-gray-700 font-medium mb-2">Your Name (public)</label>
            <input id="userName" type="text" placeholder="John Doe"
                   class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-green-500">
          </div>
          <div>
            <label class="block text-gray-700 font-medium mb-2">Price (ETH) ≥ 0.01</label>
            <input id="priceEth" type="number" step="0.001" min="0.01" placeholder="0.05"
                   class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-green-500">
          </div>
        </div>
        <button id="createOfferBtn" disabled
                class="mt-4 energy-gradient text-white w-full py-3 rounded-lg font-semibold btn-glow flex items-center justify-center">
          <span id="createText">Create Offer</span>
          <span id="createSpinner" class="hidden ml-2">
            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </span>
        </button>
        <p class="mt-2 text-sm text-gray-600">Minimum price: <strong>0.01 ETH</strong></p>
      </div>

      <!-- Offers Table -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-semibold mb-4">Active Offers</h2>
        <div id="offersContainer" class="space-y-3">
          <p class="text-gray-500 text-center">Loading offers from blockchain…</p>
        </div>
      </div>

    </div>
  </section>

  <!-- ==================== SCRIPT ==================== -->
  <script>
    // -------------------------------------------------
    // 1. NETWORK CONFIG (add more networks later)
    // -------------------------------------------------
    const CONFIG = {
      networks: {
        "1337": {               // Ganache
          name: "Ganache Local",
          rpc: "http://127.0.0.1:7545"
        },
        "11155111": {           // Sepolia
          name: "Sepolia Testnet",
          rpc: "https://eth-sepolia.g.alchemy.com/v2/YOUR_KEY"
        }
        // add mainnet, polygon, etc. here
      }
    };

    // -------------------------------------------------
    // 2. GLOBAL VARS
    // -------------------------------------------------
    let CONTRACT_ADDRESS;
    let provider;
    let signer;
    let contract;
    let userAddress;

    // -------------------------------------------------
    // 3. LOAD CONTRACT ADDRESS FROM JSON
    // -------------------------------------------------
    async function loadConfig() {
      const chainId = await window.ethereum.request({ method: 'eth_chainId' });
      const network = CONFIG.networks[chainId];
      if (!network) {
        alert(`Unsupported network (chainId ${chainId})`);
        return false;
      }

      // fetch address from backend config file
      let config;
      try {
        config = await fetch('/config/contract-address.json').then(r => r.json());
      } catch (e) {
        alert('Failed to load contract-address.json');
        return false;
      }

      CONTRACT_ADDRESS = config[chainId];
      if (!CONTRACT_ADDRESS) {
        alert(`No contract deployed on ${network.name} (chainId ${chainId})`);
        return false;
      }

      console.log(`Connected to ${network.name}: ${CONTRACT_ADDRESS}`);
      return true;
    }

    // -------------------------------------------------
    // 4. CONNECT WALLET (dynamic)
    // -------------------------------------------------
    document.getElementById("connectBtn").addEventListener("click", async () => {
      if (!window.ethereum) return alert("Install MetaMask!");

      const ok = await loadConfig();
      if (!ok) return;

      provider = new ethers.BrowserProvider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = await provider.getSigner();
      userAddress = await signer.getAddress();

      contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

      document.getElementById("accountDisplay").textContent =
        `Connected: ${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;

      document.getElementById("connectBtn").textContent = "Connected";
      document.getElementById("connectBtn").disabled = true;

      loadOffers();
      document.getElementById("createOfferBtn").disabled = false;
    });

    // -------------------------------------------------
    // 5. HASH USERNAME
    // -------------------------------------------------
    function hashUsername(name) {
      return ethers.keccak256(ethers.toUtf8Bytes(name.trim().toLowerCase()));
    }

    // -------------------------------------------------
    // 6. CREATE OFFER
    // -------------------------------------------------
    document.getElementById("createOfferBtn").addEventListener("click", async () => {
      const name = document.getElementById("userName").value.trim();
      const priceEth = document.getElementById("priceEth").value;
      if (!name || !priceEth) return alert("Fill name & price");

      const priceWei = ethers.parseEther(priceEth);
      const userHash = hashUsername(name);

      const btn = document.getElementById("createOfferBtn");
      const txt = document.getElementById("createText");
      const spin = document.getElementById("createSpinner");
      txt.textContent = "Sending…"; spin.classList.remove("hidden"); btn.disabled = true;

      try {
        const tx = await contract.createOffer(userHash, priceWei);
        await tx.wait();
        alert("Offer created on-chain!");
        document.getElementById("userName").value = "";
        document.getElementById("priceEth").value = "";
        loadOffers();
      } catch (e) {
        console.error(e);
        alert(e?.reason || "Transaction failed");
      } finally {
        txt.textContent = "Create Offer"; spin.classList.add("hidden"); btn.disabled = false;
      }
    });

    // -------------------------------------------------
    // 7. LOAD OFFERS
    // -------------------------------------------------
    async function loadOffers() {
      const container = document.getElementById("offersContainer");
      container.innerHTML = "<p class='text-gray-500 text-center'>Loading…</p>";
      try {
        const count = await contract.getOfferCount();
        const rows = [];
        for (let i = 0; i < count; i++) {
          const [userHash, priceWei, ts, active] = await contract.getOffer(i);
          if (!active) continue;
          const priceEth = ethers.formatEther(priceWei);
          const date = new Date(Number(ts) * 1000).toLocaleString();
          rows.push(`
            <div class="flex justify-between items-center p-4 border rounded-lg">
              <div>
                <p class="font-medium">Offer #${i}</p>
                <p class="text-sm text-gray-600">User hash: <code>${userHash.slice(0,10)}…</code></p>
                <p class="text-sm text-gray-600">Price: <strong>${priceEth} ETH</strong></p>
                <p class="text-xs text-gray-500">${date}</p>
              </div>
              <button onclick="acceptOffer(${i})" class="bg-green-600 text-white px-4 py-1 rounded btn-glow text-sm">Accept</button>
            </div>
          `);
        }
        container.innerHTML = rows.length ? rows.join("") : "<p class='text-center text-gray-500'>No active offers yet.</p>";
      } catch (e) {
        console.error(e);
        container.innerHTML = "<p class='text-red-600'>Failed to load offers.</p>";
      }
    }

    // -------------------------------------------------
    // 8. ACCEPT OFFER (placeholder)
    // -------------------------------------------------
    async function acceptOffer(id) {
      alert(`Accept logic for offer #${id} – implement payment/escrow here.`);
    }

    // -------------------------------------------------
    // 9. LOGOUT
    // -------------------------------------------------
    document.getElementById("logoutBtn").addEventListener("click", () => {
      sessionStorage.clear();
      window.location.href = "login.html";
    });

    // -------------------------------------------------
    // 10. AUTO-REDIRECT IF NOT LOGGED IN
    // -------------------------------------------------
    if (!sessionStorage.getItem("token")) {
      window.location.href = "login.html";
    }

    // -------------------------------------------------
    // 11. CONTRACT ABI (copy from artifacts)
    // -------------------------------------------------
    const CONTRACT_ABI = [
      "function MIN_PRICE() view returns (uint256)",
      "function createOffer(bytes32 userHash, uint256 price)",
      "function getOfferCount() view returns (uint256)",
      "function getOffer(uint256 id) view returns (bytes32, uint256, uint256, bool)",
      "function cancelOffer(uint256 id)",
      "event OfferCreated(uint256 indexed offerId, bytes32 indexed userHash, uint256 price, uint256 timestamp)"
    ];
  </script>
</body>
</html>